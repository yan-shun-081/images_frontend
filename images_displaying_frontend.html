<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=5,user-scalable=yes" />
<title>üìö Image Stream</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet">

<style>
  *{box-sizing:border-box;margin:0;padding:0;}
  body{
    font-family:'Poppins',sans-serif;
    background:linear-gradient(135deg,#0f172a,#1e293b);
    color:#fff;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding-bottom:60px;
  }
  header{
    width:100%;padding:16px;text-align:center;
    background:rgba(255,255,255,0.08);backdrop-filter:blur(12px);
    box-shadow:0 4px 20px rgba(0,0,0,.3);
    font-size:1.5em;font-weight:600;color:#60a5fa;letter-spacing:1px;
  }
  #feed{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    gap:16px;width:92%;max-width:1300px;margin-top:24px;
  }
  .card{
    background:rgba(255,255,255,0.08);border-radius:16px;padding:14px;
    display:flex;flex-direction:column;
    transition:transform .25s ease,box-shadow .25s ease;
  }
  .card:hover{
    transform:translateY(-4px);
    box-shadow:0 8px 20px rgba(0,0,0,.4);
  }
  .preview{
    width:100%;aspect-ratio:16/9;border-radius:12px;
    overflow:hidden;background:#1e293b;
    display:flex;align-items:center;justify-content:center;
  }
  .preview img{width:100%;height:100%;object-fit:cover;}
  .preview-wrapper{position:relative;width:100%;}
  .ellipsis-overlay{
    position:absolute;top:4px;left:4px;
    color:#ff4500;font-size:1.8em;font-weight:bold;
    pointer-events:none;
  }
  .info{margin-top:10px;}
  .title{
    font-size:1em;font-weight:600;color:#f8fafc;
    margin-bottom:4px;line-height:1.4;word-break:break-word;
  }
  .meta{
    font-size:.85em;color:#94a3b8;word-break:break-word;
  }
  .open-btn,
  .share-btn{
    margin-top:10px;
    border:none;
    border-radius:8px;
    padding:10px;
    font-weight:500;
    cursor:pointer;
    transition:background .25s ease;
    font-size:.95em;
  }
  .open-btn{
    background:#60a5fa;color:#fff;
  }
  .open-btn:hover{background:#3b82f6;}
  .share-btn{
    background:#34d399;color:#fff;
  }
  .share-btn:hover{background:#10b981;}
  .loader{
    margin-top:60px;border:6px solid rgba(255,255,255,.2);
    border-top:6px solid #60a5fa;border-radius:50%;
    width:45px;height:45px;animation:spin 1s linear infinite;
  }
  @keyframes spin{
    0%{transform:rotate(0);}100%{transform:rotate(360deg);}
  }
  footer{
    margin-top:30px;color:#94a3b8;font-size:.9em;text-align:center;
  }
  /* ---------- Full‚Äëscreen viewer ---------- */
  .pdf-viewer{
    position:fixed;inset:0;background:#0f172a;
    z-index:999;display:none;flex-direction:column;
  }
  .pdf-viewer.active{display:flex;}
  .pdf-toolbar{
    display:flex;justify-content:space-between;align-items:center;
    padding:10px 14px;background:rgba(15,23,42,.9);
    border-bottom:1px solid rgba(255,255,255,.1);
  }
  .pdf-toolbar h2{
    font-size:1em;color:#93c5fd;font-weight:500;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80%;
  }
  .close-full{
    background:#ef4444;border:none;color:#fff;
    font-size:1.2em;width:36px;height:36px;
    border-radius:50%;cursor:pointer;transition:background .25s ease;
  }
  .close-full:hover{background:#dc2626;}
  .pdf-content{
    flex-grow:1;overflow:auto;touch-action:none;
  }
  .pdf-iframe{
    width:100%;height:100%;border:none;display:block;
  }
</style>
</head>

<body>
<header>üìö Image Stream</header>

<div id="feed"></div>
<div id="loader" class="loader"></div>

<footer>¬© 2026 Powered by Archive &amp; Your Backend</footer>

<!-- Fullscreen Image Viewer -->
<div id="pdfViewer" class="pdf-viewer">
  <div class="pdf-toolbar">
    <h2 id="pdfTitle">Image Viewer</h2>
    <button class="close-full" id="closeViewer">&times;</button>
  </div>
  <div class="pdf-content">
    <iframe id="pdfFrame" class="pdf-iframe" src=""></iframe>
  </div>
</div>

<script>
/* --------------------------------------------------------------
   UI references
-------------------------------------------------------------- */
const FEED        = document.getElementById('feed');
const LOADER      = document.getElementById('loader');
const VIEWER      = document.getElementById('pdfViewer');
const PDF_FRAME   = document.getElementById('pdfFrame');
const PDF_TITLE   = document.getElementById('pdfTitle');
const CLOSE_VIEWER = document.getElementById('closeViewer');
const PDF_CONTENT = document.querySelector('.pdf-content');

/* --------------------------------------------------------------
   Backend / paging
-------------------------------------------------------------- */
const BACKEND_URL = 'https://images_displaying_backend.erenyeager6880.workers.dev';
let allData = [], displayedCount = 0, loading = false;
const BATCH_SIZE = 30;

/* --------------------------------------------------------------
   Helper ‚Äì get a thumbnail URL from an Archive.org ‚Äúdetails‚Äù link
-------------------------------------------------------------- */
function getThumbnailUrl(item){
  if (item.archive_url && item.archive_url.includes('archive.org/details/')){
    const id = item.archive_url.split('/details/')[1]?.split(/[/?#]/)[0];
    if (id) return `https://archive.org/services/img/${id}`;
  }
  return '';
}

/* --------------------------------------------------------------
   Helper ‚Äì get the *real* image URL (direct file if possible)
-------------------------------------------------------------- */
function getFullImageUrl(item){
  const url = (item.archive_url || '').trim();
  const low = url.toLowerCase();

  // Direct image file (.png/.jpg/.jpeg/.gif)
  if (low.endsWith('.png') || low.endsWith('.jpg') || low.endsWith('.jpeg') || low.endsWith('.gif')) {
    return url;
  }

  // Archive.org ‚Äúdetails‚Äù page ‚Äì try to compose a download URL.
  // Most items store the primary file under the same identifier.
  if (url.includes('archive.org/details/')) {
    const id = url.split('/details/')[1]?.split(/[/?#]/)[0];
    if (id) {
      // Try a common naming pattern ‚Äì the identifier followed by .jpg.
      // If it does not exist the request will simply 404, and we‚Äôll fall back.
      return `https://archive.org/download/${id}/${id}.jpg`;
    }
  }

  // Fallback: use the thumbnail (services/img) ‚Äì it‚Äôs always available.
  return getThumbnailUrl(item);
}

/* --------------------------------------------------------------
   Fetch JSON data
-------------------------------------------------------------- */
async function fetchData(){
  try{
    const res  = await fetch(BACKEND_URL);
    const data = await res.json();
    LOADER.style.display = 'none';
    if (!data || !data.length){
      FEED.innerHTML = "<p style='text-align:center;color:#94a3b8'>No Images found üò¢</p>";
      return;
    }
    allData = data;
    renderNextBatch();
  }catch(e){
    LOADER.style.display = 'none';
    FEED.innerHTML = "<p style='text-align:center;color:#f87171'>Error loading data üòû</p>";
    console.error(e);
  }
}

/* --------------------------------------------------------------
   Render a batch of cards (30 at a time)
-------------------------------------------------------------- */
function renderNextBatch(){
  if (loading) return;
  loading = true;
  const batch = allData.slice(displayedCount, displayedCount + BATCH_SIZE);
  batch.forEach((item,i)=>{
    const card = document.createElement('div');
    card.className = 'card';

    /* ----- thumbnail preview (with optional red ‚Äú...‚Äù overlay) ----- */
    const thumbUrl = getThumbnailUrl(item);
    const preview = document.createElement('div');
    preview.className = 'preview';
    if (thumbUrl){
      preview.innerHTML = `<img src="${thumbUrl}" alt="Thumbnail" loading="lazy">`;
    }else{
      preview.textContent = 'No Preview Available';
    }
    const wrapper = document.createElement('div');
    wrapper.className = 'preview-wrapper';
    wrapper.appendChild(preview);
    const low = (item.archive_url||'').toLowerCase();
    if (low.endsWith('.png') || low.endsWith('.jpg')){
      const ellipsis = document.createElement('div');
      ellipsis.className = 'ellipsis-overlay';
      ellipsis.textContent = '...';
      wrapper.appendChild(ellipsis);
    }

    /* ----- info block ----- */
    const info = document.createElement('div');
    info.className = 'info';
    info.innerHTML = `
      <div class="title">${item.title || 'Untitled Image'}</div>
      <div class="meta">üë§ ${item.username || 'Anonymous'} ‚Ä¢ üÜî ${item.id || 'N/A'}</div>
    `;

    /* ----- Share button ----- */
    const shareBtn = document.createElement('button');
    shareBtn.className = 'share-btn';
    shareBtn.textContent = 'Share Image';
    shareBtn.onclick = () => {
      // Prevent double‚Äëclicks while we download the image.
      shareBtn.disabled = true;
      const originalText = shareBtn.textContent;
      shareBtn.textContent = 'Preparing‚Ä¶';

      const imgUrl = getFullImageUrl(item);
      downloadImageAsDataURL(imgUrl)
        .then(dataUrl => {
          // Build a safe filename ‚Äì strip spaces/special chars.
          const safeTitle = (item.title || 'shared_image')
                            .replace(/[^\w\-]+/g,'_')
                            .substring(0,30);
          const fileName = safeTitle + '.jpg';
          const titleForShare = item.title || 'Shared Image';
          const extraText = '';   // you can add any extra text you like

          if (window.Android && typeof window.Android.shareImage === 'function') {
            window.Android.shareImage(dataUrl, fileName, titleForShare, extraText);
          } else {
            // Desktop fallback ‚Äì just open the image in a new tab.
            window.open(imgUrl, '_blank');
            alert('Share is only available inside the Android app.');
          }
        })
        .catch(err => {
          console.error('Error preparing image for share:', err);
          alert('Failed to prepare image for sharing.');
        })
        .finally(() => {
          shareBtn.disabled = false;
          shareBtn.textContent = originalText;
        });
    };

    /* ----- Open button ----- */
    const openBtn = document.createElement('button');
    openBtn.className = 'open-btn';
    openBtn.textContent = 'Open Image';
    openBtn.onclick = () => openFullscreenImage(item.title, item.archive_url);

    /* ----- assemble ----- */
    // Order: preview ‚Üí info ‚Üí share ‚Üí open
    card.append(wrapper, info, shareBtn, openBtn);
    FEED.appendChild(card);
    requestAnimationFrame(()=>card.classList.add('visible'));
  });
  displayedCount += batch.length;
  loading = false;
}

/* --------------------------------------------------------------
   Infinite scroll
-------------------------------------------------------------- */
window.addEventListener('scroll',()=>{
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200){
    if (displayedCount < allData.length && !loading) renderNextBatch();
  }
});

/* --------------------------------------------------------------
   Full‚Äëscreen viewer (pinch / mouse‚Äëwheel zoom)
-------------------------------------------------------------- */
let currentScale = 1;
const MIN_SCALE = 0.5;
const MAX_SCALE = 5;

function applyScale(){
  PDF_FRAME.style.transform = `scale(${currentScale})`;
  PDF_FRAME.style.transformOrigin = '0 0';
}

/* Open image in full‚Äëscreen viewer */
function openFullscreenImage(title, archiveUrl){
  if (!archiveUrl) return;
  const embedUrl = archiveUrl.includes('archive.org')
    ? archiveUrl.replace('/details/','/embed/')
    : archiveUrl;
  PDF_TITLE.textContent = title || 'Image Viewer';
  PDF_FRAME.src = embedUrl;
  VIEWER.classList.add('active');
  currentScale = 1;
  applyScale();
}

/* Close viewer */
function closeViewer(){
  VIEWER.classList.remove('active');
  PDF_FRAME.src = '';
  currentScale = 1;
  applyScale();
}
CLOSE_VIEWER.onclick = closeViewer;
document.addEventListener('keydown',e=>{
  if (e.key === 'Escape') closeViewer();
});

/* ----- mouse‚Äëwheel zoom ----- */
PDF_CONTENT.addEventListener('wheel',e=>{
  e.preventDefault();
  const factor = e.deltaY < 0 ? 1.1 : 0.9;
  const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, currentScale * factor));
  if (newScale !== currentScale){
    const rect = PDF_FRAME.getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    const scrollL = PDF_CONTENT.scrollLeft;
    const scrollT = PDF_CONTENT.scrollTop;
    const ratio = newScale / currentScale;
    currentScale = newScale;
    applyScale();
    PDF_CONTENT.scrollLeft = (cx + scrollL) * ratio - cx;
    PDF_CONTENT.scrollTop  = (cy + scrollT) * ratio - cy;
  }
},{passive:false});

/* ----- pinch‚Äëzoom (touch) ----- */
let pinchStartDist = null;
let pinchStartScale = 1;
function getDist(t1,t2){
  const dx = t2.clientX - t1.clientX;
  const dy = t2.clientY - t1.clientY;
  return Math.hypot(dx,dy);
}
PDF_CONTENT.addEventListener('touchstart',e=>{
  if (e.touches.length===2){
    pinchStartDist = getDist(e.touches[0], e.touches[1]);
    pinchStartScale = currentScale;
    e.preventDefault();
  }
},{passive:false});

PDF_CONTENT.addEventListener('touchmove',e=>{
  if (e.touches.length===2 && pinchStartDist){
    const curDist = getDist(e.touches[0], e.touches[1]);
    const scaleFactor = curDist / pinchStartDist;
    const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, pinchStartScale * scaleFactor));
    if (newScale !== currentScale){
      currentScale = newScale;
      applyScale();
    }
    e.preventDefault();
  }
},{passive:false});

PDF_CONTENT.addEventListener('touchend',e=>{
  if (e.touches.length<2) pinchStartDist = null;
});

/* --------------------------------------------------------------
   Utility ‚Äì fetch an image and convert to Base64 data‚ÄëURL
-------------------------------------------------------------- */
function downloadImageAsDataURL(url){
  // The fetch must be allowed by CORS (Archive.org sends Access‚ÄëControl‚ÄëAllow‚ÄëOrigin: *).
  return fetch(url, {mode: 'cors'})
    .then(resp => {
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.blob();
    })
    .then(blob => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result); // result is a data:URL
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    }));
}

/* --------------------------------------------------------------
   Kick‚Äëoff ‚Äì fetch JSON data
-------------------------------------------------------------- */
fetchData();
</script>
</body>
</html>
